name: Otomatik Sürüm Yayınlayıcı

# Bu ayar sayesinde sadece "v" ile başlayan etiketlerde (v1.2, v1.3 gibi) çalışır.
on:
  push:
    tags:
      - 'v*' 

# Release oluşturabilmesi için yazma izni veriyoruz
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Kütüphaneleri Yükle
      run: |
        pip install customtkinter playwright m3u8 pillow requests pyinstaller
        $env:PLAYWRIGHT_BROWSERS_PATH="0"
        python -m playwright install chromium

    - name: FFmpeg İndir
      run: |
        Invoke-WebRequest -Uri https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip -OutFile ffmpeg.zip
        Expand-Archive ffmpeg.zip -DestinationPath .
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-master-*" | Select-Object -First 1
        Move-Item "$($ffmpegDir.FullName)\bin\ffmpeg.exe" .

    - name: Derle ve Paketle (EXE + FFmpeg)
      run: |
        $pwPath = python -c "import playwright; print(playwright.__path__[0])"
        $pwPath = $pwPath.Trim()
        
        # EXE Oluştur
        pyinstaller --noconfirm --onefile --windowed --name "KickStudioUltimate" --add-data "$pwPath\driver\package\.local-browsers;playwright/driver/package/.local-browsers" --collect-all customtkinter main.py
        
        # FFmpeg'i de dist klasörüne at
        Copy-Item ffmpeg.exe dist/

    # --- İŞTE SİHİRLİ KISIM BURASI ---
    # Dosyaları ZIP yapar (Kuzenine tek dosya atman için)
    - name: Dosyaları Ziple
      run: |
        Compress-Archive -Path dist\* -DestinationPath KickStudio_Guncel.zip

    # GitHub Release Sayfasına Otomatik Yükler
    - name: Release Oluştur ve Yükle
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: KickStudio_Guncel.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        generate_release_notes: true
